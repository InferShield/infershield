# Stripe Setup Guide for InferShield

## Quick Start

### 1. Get Your Stripe API Keys

1. Go to https://dashboard.stripe.com/test/apikeys (test mode)
2. Copy your **Secret key** (starts with `sk_test_`)
3. Copy your **Publishable key** (starts with `pk_test_`)

### 2. Update Environment Variables

Edit `backend/.env`:

```bash
# Replace these with your actual Stripe keys
STRIPE_SECRET_KEY=sk_test_your_actual_secret_key_here
STRIPE_PUBLISHABLE_KEY=pk_test_your_actual_publishable_key_here
STRIPE_WEBHOOK_SECRET=whsec_test_placeholder_update_after_webhook_creation

# These will be auto-generated by init-stripe.js
STRIPE_PRICE_PRO=price_xxxxx
STRIPE_PRICE_ENTERPRISE=price_xxxxx
```

### 3. Initialize Stripe Products

Run the initialization script:

```bash
cd backend
node scripts/init-stripe.js
```

This will:
- Create "InferShield Pro" product ($99/month)
- Create "InferShield Enterprise" product ($499/month)
- Generate Price IDs for each

### 4. Update .env with Price IDs

Copy the Price IDs from the script output and update your `.env`:

```bash
STRIPE_PRICE_PRO=price_1abc123...
STRIPE_PRICE_ENTERPRISE=price_1def456...
```

### 5. Restart Backend

```bash
npm run dev
# or in production
pm2 restart infershield
```

## Testing Checkout Flow

1. Visit https://app.infershield.io/pricing.html
2. Click "Upgrade to Pro"
3. Use Stripe test card: `4242 4242 4242 4242`
4. Any future expiry date
5. Any CVC

## Webhooks (Optional)

For production, set up webhooks to handle:
- `customer.subscription.created`
- `customer.subscription.updated`
- `customer.subscription.deleted`
- `invoice.payment_succeeded`
- `invoice.payment_failed`

1. Go to https://dashboard.stripe.com/test/webhooks
2. Add endpoint: `https://app.infershield.io/api/webhooks/stripe`
3. Select events above
4. Copy webhook signing secret
5. Update `STRIPE_WEBHOOK_SECRET` in `.env`

## Price IDs Reference

| Plan | Monthly Price | Description |
|------|--------------|-------------|
| Free | $0 | 100 requests/month |
| Pro | $99 | 10,000 requests/month |
| Enterprise | $499 | Unlimited requests |

## Troubleshooting

### "Invalid API Key" Error

- Make sure you're using the correct environment (test vs live)
- Keys start with `sk_test_` (test) or `sk_live_` (production)
- Don't commit real keys to git!

### Products Already Exist

The script checks for existing products and won't duplicate them. Safe to run multiple times.

### Price IDs Not Found

Make sure `.env` is loaded and Price IDs are set correctly. The backend will return an error if they're missing.

## Going Live

1. Switch to live mode in Stripe Dashboard
2. Get live keys (start with `sk_live_` and `pk_live_`)
3. Run `init-stripe.js` again with live keys
4. Update production `.env` with live Price IDs
5. Set up live webhooks
6. Update `FRONTEND_URL` to production domain

---

**Need help?** Check the Stripe docs: https://stripe.com/docs/billing/subscriptions/overview
