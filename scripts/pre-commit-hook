#!/bin/bash
# InferShield Pre-Commit Hook
# Automatically scans staged changes for PII and security threats

set -euo pipefail

# Config
ENDPOINT="${INFERSHIELD_ENDPOINT:-http://localhost:5000}"
API_KEY="${INFERSHIELD_API_KEY:-}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}ğŸ›¡ï¸  InferShield: Scanning staged changes...${NC}"
echo ""

# Check API key
if [ -z "$API_KEY" ]; then
  echo -e "${YELLOW}âš ï¸  Warning: INFERSHIELD_API_KEY not set${NC}"
  echo "Skipping InferShield scan."
  echo ""
  echo "To enable:"
  echo "  export INFERSHIELD_API_KEY='isk_live_...'"
  echo ""
  exit 0
fi

# Check dependencies
if ! command -v curl &> /dev/null || ! command -v jq &> /dev/null; then
  echo -e "${YELLOW}âš ï¸  Warning: curl or jq not found${NC}"
  echo "Skipping InferShield scan."
  exit 0
fi

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "No files to scan."
  exit 0
fi

# Scan each file
BLOCKED=0
SCANNED=0

for FILE in $STAGED_FILES; do
  # Skip binary files and large files
  if file "$FILE" | grep -q "binary"; then
    echo -e "${YELLOW}âŠ˜ Skipping binary: $FILE${NC}"
    continue
  fi
  
  SIZE=$(wc -c < "$FILE" 2>/dev/null || echo 0)
  if [ "$SIZE" -gt 100000 ]; then
    echo -e "${YELLOW}âŠ˜ Skipping large file: $FILE ($(numfmt --to=iec-i --suffix=B $SIZE))${NC}"
    continue
  fi
  
  # Scan
  echo -n "Scanning: $FILE ... "
  
  CONTENT=$(git show ":$FILE")
  ESCAPED=$(echo "$CONTENT" | jq -Rs .)
  
  RESULT=$(curl -s "$ENDPOINT/api/analyze" \
    -H "X-API-Key: $API_KEY" \
    -H "Content-Type: application/json" \
    -d "{\"prompt\":$ESCAPED,\"agent_id\":\"git-hook\",\"metadata\":{\"file\":\"$FILE\"}}" 2>&1)
  
  if [ $? -ne 0 ]; then
    echo -e "${YELLOW}âš ï¸  Connection error${NC}"
    continue
  fi
  
  SUCCESS=$(echo "$RESULT" | jq -r '.success // false')
  if [ "$SUCCESS" != "true" ]; then
    echo -e "${YELLOW}âš ï¸  API error${NC}"
    continue
  fi
  
  THREAT=$(echo "$RESULT" | jq -r '.threat_detected')
  RISK=$(echo "$RESULT" | jq -r '.risk_score')
  
  ((SCANNED++))
  
  if [ "$THREAT" = "true" ]; then
    echo -e "${RED}âŒ BLOCKED (Risk: $RISK/100)${NC}"
    echo ""
    echo -e "${RED}  Threats found:${NC}"
    echo "$RESULT" | jq -r '.threats[] | "    â€¢ \(.severity | ascii_upcase): \(.pattern)"'
    echo ""
    BLOCKED=1
  else
    echo -e "${GREEN}âœ… Clean (Risk: $RISK/100)${NC}"
  fi
done

echo ""

if [ $BLOCKED -eq 1 ]; then
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${RED}âŒ COMMIT BLOCKED${NC}"
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo "Sensitive data or threats detected in staged files."
  echo ""
  echo "Options:"
  echo "  1. Remove sensitive data and try again"
  echo "  2. Use git commit --no-verify (not recommended)"
  echo ""
  exit 1
else
  echo -e "${GREEN}âœ… All files passed InferShield scan! ($SCANNED files)${NC}"
  echo ""
  exit 0
fi
